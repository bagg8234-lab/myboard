{% extends "base.html" %}

{% block content %}
<div class="container py-4">

  <!-- Header -->
  <div class="d-flex align-items-center justify-content-between mb-3">
    <h1 class="fw-bold m-0">ğŸ¥ ë³‘ì•„ë¦¬ ì •ë³´</h1>

    <div class="d-flex align-items-center gap-2">
      <span class="badge bg-secondary">ì´ {{ results|length if results else 0 }}ê±´</span>
      <button id="resetAllBtn" class="btn btn-outline-secondary btn-sm" type="button">
        ì „ì²´ ì´ˆê¸°í™”
      </button>
      <a href="{{ url_for('index') }}" class="btn btn-outline-secondary btn-sm">â† ë©”ì¸</a>
    </div>
  </div>

  <div class="card shadow-sm border-0">
    <div class="card-body p-0">

      {% if results and results|length > 0 %}
      <div class="table-responsive" style="max-height: 75vh;">
        <table id="resultTable" class="table table-bordered table-hover align-middle mb-0 table-white">
          <thead class="sticky-top table-head-white">
            <tr>
              {% for key in results[0].keys() %}
              <th class="text-nowrap position-relative bg-white" data-col-index="{{ loop.index0 }}">
                <div class="d-flex align-items-center justify-content-between gap-2">
                  <span class="fw-semibold">{{ key }}</span>

                  <!-- â–¼ í•„í„° ë²„íŠ¼ -->
                  <div class="dropdown">
                    <button class="btn btn-sm btn-light border py-0 px-2"
                            type="button"
                            data-bs-toggle="dropdown"
                            data-bs-auto-close="outside"
                            aria-expanded="false"
                            title="í•„í„°">
                      â–¼
                    </button>

                    <div class="dropdown-menu p-2 shadow-sm" style="min-width: 240px; max-height: 300px; overflow:auto;">
                      <div class="d-flex justify-content-between align-items-center mb-2">
                        <span class="small text-muted">í•„í„° ì„ íƒ</span>
                        <button class="btn btn-sm btn-link text-decoration-none p-0 clear-filter-btn"
                                type="button"
                                data-col-index="{{ loop.index0 }}">
                          ì´ˆê¸°í™”
                        </button>
                      </div>

                      <div class="filter-box" data-col-index="{{ loop.index0 }}">
                        <!-- JSê°€ ê°’ ëª©ë¡ ì±„ì›€ -->
                      </div>
                    </div>
                  </div>
                </div>
              </th>
              {% endfor %}
            </tr>
          </thead>

          <tbody id="tableBody">
            {% for result in results %}
            <tr>
              {% for value in result.values() %}
              <td data-col-index="{{ loop.index0 }}" class="bg-white">
                {% if value is none %}
                  <span class="text-muted">-</span>
                {% else %}
                  <span class="d-inline-block text-truncate" style="max-width: 260px;" title="{{ value }}">
                    {{ value }}
                  </span>
                {% endif %}
              </td>
              {% endfor %}
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
      {% else %}
      <div class="p-4">
        <div class="alert alert-warning mb-0">
          ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.
        </div>
      </div>
      {% endif %}

    </div>
  </div>

</div>

{% if results and results|length > 0 %}
<style>
  /* âœ… â€œí‘œì²˜ëŸ¼ í•˜ì–—ê²Œâ€ ë³´ì´ë„ë¡ */
  .table-white {
    background: #ffffff;
  }

  .table-head-white th {
    background: #ffffff !important;
    border-bottom: 1px solid #e5e7eb;
  }

  /* ì¤„ë¬´ëŠ¬ ì—†ì• ê³  ì‹¶ìœ¼ë©´ ì´ê±° ì“°ë©´ ë¨ (ì›í•˜ë©´ ë§í•´ì¤˜)
  .table-white tbody tr:nth-child(odd) td {
    background: #ffffff !important;
  }
  */

  /* hover ëŠë‚Œ ì€ì€í•˜ê²Œ */
  .table-white tbody tr:hover td {
    background: #f8fafc !important;
  }

  th, td {
    vertical-align: middle;
  }
</style>

<script>
  (function () {
    const table = document.getElementById("resultTable");
    const tbody = document.getElementById("tableBody");
    const rows = Array.from(tbody.querySelectorAll("tr"));
    const resetAllBtn = document.getElementById("resetAllBtn");

    // colIndex -> Set(selectedValues)
    const filters = new Map();

    function getUniqueValues(colIndex) {
      const values = new Set();
      rows.forEach(row => {
        const cell = row.querySelector(`td[data-col-index="${colIndex}"]`);
        if (cell) values.add(cell.innerText.trim());
      });
      return Array.from(values).sort();
    }

    function applyFilters() {
      rows.forEach(row => {
        let visible = true;

        for (const [colIndex, selectedSet] of filters.entries()) {
          const cell = row.querySelector(`td[data-col-index="${colIndex}"]`);
          const cellValue = cell ? cell.innerText.trim() : "";

          if (!selectedSet.has(cellValue)) {
            visible = false;
            break;
          }
        }

        row.style.display = visible ? "" : "none";
      });
    }

    function handleFilterChange(colIndex) {
      const box = document.querySelector(`.filter-box[data-col-index="${colIndex}"]`);
      const checked = Array.from(box.querySelectorAll(".value-check:checked"))
        .map(x => x.value);

      if (checked.length === 0) {
        filters.delete(colIndex); // ì•„ë¬´ê²ƒë„ ì„ íƒ ì•ˆí•˜ë©´ í•„í„° í•´ì œ
      } else {
        filters.set(colIndex, new Set(checked));
      }

      applyFilters();
    }

    function buildFilterUI(colIndex) {
      const box = document.querySelector(`.filter-box[data-col-index="${colIndex}"]`);
      if (!box) return;

      const uniqueValues = getUniqueValues(colIndex);
      box.innerHTML = "";

      // âœ… ì „ì²´ ì„ íƒ í† ê¸€ ì²´í¬ë°•ìŠ¤(í•œë²ˆ ëˆ„ë¥´ë©´ ì„ íƒ / ë‹¤ì‹œ ëˆ„ë¥´ë©´ í•´ì œ)
      const allWrap = document.createElement("div");
      allWrap.className = "form-check mb-2";

      const allId = `selectAll_${colIndex}`;

      const allChk = document.createElement("input");
      allChk.className = "form-check-input";
      allChk.type = "checkbox";
      allChk.id = allId;

      const allLabel = document.createElement("label");
      allLabel.className = "form-check-label small fw-semibold";
      allLabel.setAttribute("for", allId);
      allLabel.innerText = "ì „ì²´ ì„ íƒ";

      allWrap.appendChild(allChk);
      allWrap.appendChild(allLabel);
      box.appendChild(allWrap);

      const divider = document.createElement("div");
      divider.className = "border-top mb-2";
      box.appendChild(divider);

      // ê°’ ì²´í¬ë°•ìŠ¤ ëª©ë¡
      const listWrap = document.createElement("div");
      box.appendChild(listWrap);

      uniqueValues.forEach(val => {
        const safeVal = val.replaceAll(" ", "_");
        const id = `f_${colIndex}_${safeVal}`;

        const wrap = document.createElement("div");
        wrap.className = "form-check";

        const input = document.createElement("input");
        input.className = "form-check-input value-check";
        input.type = "checkbox";
        input.id = id;
        input.value = val;

        // ê¸°ì¡´ í•„í„° ìƒíƒœ ë°˜ì˜
        if (filters.has(colIndex)) {
          input.checked = filters.get(colIndex).has(val);
        } else {
          input.checked = false;
        }

        input.addEventListener("change", () => {
          // ê°œë³„ ì²´í¬ ë³€ê²½ -> ì „ì²´ì„ íƒ ì²´í¬ë°•ìŠ¤ ìƒíƒœë„ ê°±ì‹ 
          updateSelectAllState(colIndex);
          handleFilterChange(colIndex);
        });

        const label = document.createElement("label");
        label.className = "form-check-label small";
        label.setAttribute("for", id);
        label.innerText = val;

        wrap.appendChild(input);
        wrap.appendChild(label);
        listWrap.appendChild(wrap);
      });

      // âœ… ì „ì²´ ì„ íƒ ì²´í¬ ìƒíƒœ ì´ˆê¸° ì„¸íŒ…
      updateSelectAllState(colIndex);

      // âœ… ì „ì²´ ì„ íƒ í† ê¸€ ê¸°ëŠ¥
      allChk.addEventListener("change", () => {
        const shouldCheck = allChk.checked;

        listWrap.querySelectorAll(".value-check").forEach(chk => {
          chk.checked = shouldCheck;
        });

        handleFilterChange(colIndex);
      });
    }

    function updateSelectAllState(colIndex) {
      const box = document.querySelector(`.filter-box[data-col-index="${colIndex}"]`);
      if (!box) return;

      const allChk = box.querySelector(`#selectAll_${colIndex}`);
      const valueChecks = Array.from(box.querySelectorAll(".value-check"));

      if (!allChk || valueChecks.length === 0) return;

      const checkedCount = valueChecks.filter(chk => chk.checked).length;

      // âœ… ëª¨ë‘ ì²´í¬ë˜ì–´ ìˆìœ¼ë©´ ì „ì²´ì„ íƒ ì²´í¬ ON
      // âœ… í•˜ë‚˜ë¼ë„ ë¹ ì ¸ìˆìœ¼ë©´ OFF
      allChk.checked = (checkedCount === valueChecks.length);
    }

    // âœ… ì—´ë³„ ì´ˆê¸°í™” ë²„íŠ¼(ê¸°ì¡´ ìœ ì§€)
    document.querySelectorAll(".clear-filter-btn").forEach(btn => {
      btn.addEventListener("click", () => {
        const colIndex = btn.dataset.colIndex;
        filters.delete(colIndex);

        // ë“œë¡­ë‹¤ìš´ UI ì•ˆ ì²´í¬ í•´ì œ
        const box = document.querySelector(`.filter-box[data-col-index="${colIndex}"]`);
        if (box) {
          box.querySelectorAll("input[type='checkbox']").forEach(chk => chk.checked = false);
        }

        applyFilters();
      });
    });

    // âœ… ì „ì²´ ì´ˆê¸°í™”(ë‹¤ì‹œ ì˜¬ë¦¬ê¸°) - ë¬´ì¡°ê±´ ë³µêµ¬ë˜ê²Œ ê°•ë ¥í•˜ê²Œ ì²˜ë¦¬
    resetAllBtn.addEventListener("click", () => {
      filters.clear();

      // ëª¨ë“  í–‰ ë‹¤ì‹œ ë³´ì´ê¸°
      rows.forEach(row => {
        row.style.display = "";
      });

      // ì—´ë ¤ìˆëŠ” ë“œë¡­ë‹¤ìš´ UI ì²´í¬ë°•ìŠ¤ë„ ì´ˆê¸°í™”
      document.querySelectorAll(".filter-box input[type='checkbox']").forEach(chk => {
        chk.checked = false;
      });

      // í˜¹ì‹œ ë‚¨ì•„ìˆëŠ” í•„í„° ì ìš©ì´ ìˆìœ¼ë©´ ë‹¤ì‹œ í•œë²ˆ ì ìš©(ì•ˆì „ì¥ì¹˜)
      applyFilters();
    });

    // âœ… ë“œë¡­ë‹¤ìš´ ì—´ë¦´ ë•Œë§ˆë‹¤ ê°’ ëª©ë¡ ê°±ì‹ 
    const dropdownButtons = table.querySelectorAll("thead button[data-bs-toggle='dropdown']");
    dropdownButtons.forEach(btn => {
      btn.addEventListener("click", () => {
        const th = btn.closest("th");
        const colIndex = th.dataset.colIndex;
        buildFilterUI(colIndex);
      });
    });

  })();
</script>

{% endif %}
{% endblock %}
