{% extends "base.html" %}

{% block content %}
<div class="container py-4">

  <!-- Header -->
  <div class="d-flex align-items-center justify-content-between mb-3">
    <div>
      <h1 class="fw-bold m-0" style="font-size: 2.2rem;">ğŸ£ ë³‘ì•„ë¦¬ ì •ë³´ ğŸ£</h1>
      <p class="text-muted mb-0" style="font-size: 1.1rem;">ìŠ¤í‚¤ë§ˆ : fms | í…Œì´ë¸” : chick_info</p>
    </div>

    <div class="d-flex align-items-center gap-2">
      <span class="badge bg-secondary" style="font-size: 1.1rem;">ì´ {{ results|length if results else 0 }}ê±´</span>
      
    </div>
  </div>

  <div class="card shadow-sm border-0">
    <div class="card-body p-0">

      {% if results and results|length > 0 %}
      <div class="table-responsive" style="max-height: 75vh;">
        <table id="resultTable" class="table table-bordered table-hover align-middle mb-0 table-white">
          <thead class="sticky-top table-head-white">
            <tr>
              {% for key in results[0].keys() %}
              <th class="position-relative" data-col-index="{{ loop.index0 }}">
                <div class="d-flex flex-column align-items-start gap-1">
                  <span class="fw-semibold" style="font-size: 1.1rem;">{{ key }}</span>
                  <div class="filter-wrap">
                    <button class="filter-btn"
                            type="button"
                            data-col-index="{{ loop.index0 }}"
                            title="í•„í„°">
                      â–¼
                    </button>

                    <div class="filter-popover" data-col-index="{{ loop.index0 }}">
                      <div class="filter-box" data-col-index="{{ loop.index0 }}">
                        <!-- JSê°€ ê°’ ëª©ë¡ ì±„ì›€ -->
                      </div>
                    </div>
                  </div>
                </div>
              </th>
              {% endfor %}
            </tr>
          </thead>

          <tbody id="tableBody">
  {% for result in results %}
  <tr>
    {% for key, value in result.items() %}
    <td data-col-index="{{ loop.index0 }}" class="bg-white text-center" style="font-size: 1.1rem;">

      {% if value is none %}
        <span class="text-muted">-</span>

      {% elif key == 'gender' %}
        {% if value == 'M' %}
          <span class="gender-badge gender-m">ìˆ˜ì»·</span>
        {% elif value == 'F' %}
          <span class="gender-badge gender-f">ì•”ì»·</span>
        {% else %}
          <span class="gender-badge gender-etc">{{ value }}</span>
        {% endif %}

      {% else %}
        <span title="{{ value }}">{{ value }}</span>
      {% endif %}

    </td>
    {% endfor %}
  </tr>
  {% endfor %}
</tbody>

        </table>
      </div>
      {% else %}
      <div class="p-4">
        <div class="alert alert-warning mb-0">
          ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.
        </div>
      </div>
      {% endif %}

    </div>
  </div>

</div>

{% if results and results|length > 0 %}
<style>
  :root {
    --bg: #ffffff;
    --text: #111827;
    --muted: #6b7280;
    --line: #e5e7eb;
    --line-strong: #d1d5db;
    --header-bg: #f8fafc;
    --header-text: #374151;
    --chip-bg: #e5e7eb;
    --chip-text: #374151;
  }

  /* âœ… â€œí‘œì²˜ëŸ¼ í•˜ì–—ê²Œâ€ ë³´ì´ë„ë¡ */
  .table-white {
    background: var(--bg);
  }

  .table-head-white th {
    background: var(--header-bg) !important;
    color: var(--header-text) !important;
    border-bottom: 1px solid var(--line-strong) !important;
  }

  .table-white tbody tr:hover td {
    background: #f9fafb !important;
  }

  th, td {
    vertical-align: middle;
    color: var(--text);
  }

  #resultTable {
    table-layout: fixed !important;
    width: 100% !important;
    border: 1px solid var(--line-strong);
  }

  #resultTable th,
  #resultTable td {
    border: 1px solid var(--line);
    word-wrap: break-word;
    word-break: break-word;
  }

  /* âœ… í‘œ ì»´íŒ©íŠ¸í•˜ê²Œ */
  #resultTable th, #resultTable td {
    padding: 6px 10px !important;
    font-size: 0.95rem !important;
  }

  /* âœ… í—¤ë”ëŠ” ìŠ¤í¬ë¡¤í•´ë„ ê³ ì • */
  #resultTable thead th {
    position: sticky;
    top: 0;
    z-index: 5;
  }

  /* âœ… ì²«ë²ˆì§¸ ì»¬ëŸ¼(chick_no) ê³ ì • */
  #resultTable th:first-child,
  #resultTable td:first-child {
    position: sticky;
    left: 0;
    z-index: 6;
    background: #ffffff;   /* ê³ ì •ëœ ì¹¸ ë°°ê²½ í°ìƒ‰ */
  }

  /* âœ… ì²«ë²ˆì§¸ í—¤ë”ëŠ” ê°€ì¥ ìœ„ë¡œ */
  #resultTable thead th:first-child {
    z-index: 10;
    background: #f8fafc;
  }

  .badge.bg-secondary {
    background: var(--chip-bg) !important;
    color: var(--chip-text) !important;
  }
</style>

<!-- í—¤ë” ìŠ¤íƒ€ì¼ ì¶”ê°€ -->
<style>
  .table-head-white th span {
    color: var(--header-text) !important;
  }

  .table-head-white th .btn-light {
    background-color: #f9fafb !important;
    border-color: var(--line) !important;
    color: var(--muted) !important;
  }

  .table-head-white th .btn-light:hover {
    background-color: var(--header-bg) !important;
  }

  .gender-badge{
  display: inline-block;
  padding: 4px 10px;
  border-radius: 999px;
  font-weight: 700;
  font-size: 0.95rem;
  border: 1px solid var(--line);
  letter-spacing: 0.02em;
}

.gender-m{
  background: #dbeafe;   /* ì—°í•œ íŒŒë‘ */
  color: #1e3a8a;        /* ì§„í•œ íŒŒë‘ */
  border-color: #bfdbfe;
}

.gender-f{
  background: #ffe4e6;   /* ì—°í•œ í•‘í¬ */
  color: #9f1239;        /* ì§„í•œ í•‘í¬ */
  border-color: #fecdd3;
}

.gender-etc{
  background: #f3f4f6;
  color: #374151;
  border-color: #e5e7eb;
}

/* âœ… í•„í„° ë²„íŠ¼/íŒì—… Excel ëŠë‚Œ */
.filter-wrap {
  position: relative;
  display: inline-block;
}

.filter-btn {
  background: #ffffff;
  border: 1px solid #d1d5db;
  border-radius: 6px;
  padding: 2px 8px;
  font-size: 0.9rem;
  cursor: pointer;
}

.filter-btn:hover {
  background: #f9fafb;
}

.filter-popover {
  display: none;
  position: absolute;
  top: 100%;
  left: 0;
  margin-top: 6px;
  background: #ffffff;
  border: 1px solid #e5e7eb;
  border-radius: 10px;
  box-shadow: 0 8px 24px rgba(0,0,0,0.12);
  width: 240px;
  max-height: 300px;
  overflow: auto;
  z-index: 9999;
  padding: 10px;
}

</style>

<script>
  (function () {
    const table = document.getElementById("resultTable");
    const tbody = document.getElementById("tableBody");
    const rows = Array.from(tbody.querySelectorAll("tr"));

    const filters = new Map(); // colIndex -> Set

    function getUniqueValues(colIndex) {
      const values = new Set();
      rows.forEach(row => {
        const cell = row.querySelector(`td[data-col-index="${colIndex}"]`);
        if (cell) values.add(cell.innerText.trim());
      });
      return Array.from(values).sort();
    }

    function applyFilters() {
      rows.forEach(row => {
        let visible = true;

        for (const [colIndex, selectedSet] of filters.entries()) {
          const cell = row.querySelector(`td[data-col-index="${colIndex}"]`);
          const cellValue = cell ? cell.innerText.trim() : "";
          if (!selectedSet.has(cellValue)) {
            visible = false;
            break;
          }
        }

        row.style.display = visible ? "" : "none";
      });
    }

    function updateFilter(colIndex) {
      const box = document.querySelector(`.filter-box[data-col-index="${colIndex}"]`);
      const checked = Array.from(box.querySelectorAll(".value-check:checked"))
        .map(x => x.value);

      if (checked.length === 0) {
        filters.delete(colIndex);
      } else {
        filters.set(colIndex, new Set(checked));
      }

      applyFilters();
    }

    function buildFilterUI(colIndex) {
      const box = document.querySelector(`.filter-box[data-col-index="${colIndex}"]`);
      if (!box) return;

      const values = getUniqueValues(colIndex);
      box.innerHTML = "";

      // âœ… ì „ì²´ ì„ íƒ í† ê¸€
      const allWrap = document.createElement("div");
      allWrap.className = "form-check mb-2";

      const allId = `selectAll_${colIndex}`;
      allWrap.innerHTML = `
        <input class="form-check-input" type="checkbox" id="${allId}">
        <label class="form-check-label small fw-semibold" for="${allId}">ì „ì²´ ì„ íƒ</label>
      `;
      box.appendChild(allWrap);

      box.appendChild(document.createElement("hr"));

      const listWrap = document.createElement("div");
      box.appendChild(listWrap);

      values.forEach(v => {
        const id = `v_${colIndex}_${v.replaceAll(" ", "_")}`;
        const checked = filters.has(colIndex) && filters.get(colIndex).has(v);

        const item = document.createElement("div");
        item.className = "form-check";
        item.innerHTML = `
          <input class="form-check-input value-check" type="checkbox" id="${id}" value="${v}" ${checked ? "checked" : ""}>
          <label class="form-check-label small" for="${id}">${v}</label>
        `;
        listWrap.appendChild(item);
      });

      // ì „ì²´ ì„ íƒ ìƒíƒœ ê°±ì‹ 
      const allChk = document.getElementById(allId);
      const valueChecks = Array.from(listWrap.querySelectorAll(".value-check"));

      function refreshAllState() {
        const checkedCount = valueChecks.filter(x => x.checked).length;
        allChk.checked = (checkedCount === valueChecks.length);
      }

      refreshAllState();

      // ì „ì²´ì„ íƒ í† ê¸€
      allChk.addEventListener("change", () => {
        valueChecks.forEach(x => x.checked = allChk.checked);
        updateFilter(colIndex);
      });

      // ê°œë³„ ì²´í¬ ë³€í™”
      valueChecks.forEach(chk => {
        chk.addEventListener("change", () => {
          refreshAllState();
          updateFilter(colIndex);
        });
      });
    }

    // âœ… íŒì—… ì—´ê³  ë‹«ê¸°
    function closeAllPopovers() {
      document.querySelectorAll(".filter-popover").forEach(p => p.style.display = "none");
    }

    document.querySelectorAll(".filter-btn").forEach(btn => {
      btn.addEventListener("click", (e) => {
        e.stopPropagation();

        const colIndex = btn.dataset.colIndex;
        const pop = document.querySelector(`.filter-popover[data-col-index="${colIndex}"]`);

        // ì—´ê¸° ì „ì— UI êµ¬ì„±
        buildFilterUI(colIndex);

        // ë‹¤ë¥¸ íŒì—… ë‹«ê³ , í˜„ì¬ í† ê¸€
        const isOpen = pop.style.display === "block";
        closeAllPopovers();
        pop.style.display = isOpen ? "none" : "block";
      });
    });

    // ë°”ê¹¥ í´ë¦­í•˜ë©´ ë‹«í˜
    document.addEventListener("click", () => {
      closeAllPopovers();
    });

  })();
</script>

{% endif %}
{% endblock %}
